// t3d-particle
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("t3d")):"function"==typeof define&&define.amd?define(["exports","t3d"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).t3d=t.t3d||{},t.t3d)}(this,(function(t,e){"use strict";function r(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(r){if("default"!==r){var i=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,i.get?i:{enumerable:!0,get:function(){return t[r]}})}})),e.default=t,Object.freeze(e)}var i=r(e),a={distributions:{BOX:1,SPHERE:2,DISC:3,LINE:4},valueOverLifetimeLength:4};function n(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,(a=i.key,n=void 0,"symbol"==typeof(n=function(t,e){if("object"!=typeof t||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(a,"string"))?n:String(n)),i)}var a,n}function o(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,s(t,e)}function s(t,e){return s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},s(t,e)}var u,l,c,h={types:{BOOLEAN:"boolean",STRING:"string",NUMBER:"number",OBJECT:"object"},ensureTypedArg:function(t,e,r){return typeof t===e?t:r},ensureArrayTypedArg:function(t,e,r){if(Array.isArray(t)){for(var i=t.length-1;i>=0;--i)if(typeof t[i]!==e)return r;return t}return this.ensureTypedArg(t,e,r)},ensureInstanceOf:function(t,e,r){return void 0!==e&&t instanceof e?t:r},ensureArrayInstanceOf:function(t,e,r){if(Array.isArray(t)){for(var i=t.length-1;i>=0;--i)if(void 0!==e&&t[i]instanceof e==!1)return r;return t}return this.ensureInstanceOf(t,e,r)},ensureValueOverLifetimeCompliance:function(t,e,r){e=e||3,r=r||3,!1===Array.isArray(t._value)&&(t._value=[t._value]),!1===Array.isArray(t._spread)&&(t._spread=[t._spread]);var i=this.clamp(t._value.length,e,r),a=this.clamp(t._spread.length,e,r),n=Math.max(i,a);t._value.length!==n&&(t._value=this.interpolateArray(t._value,n)),t._spread.length!==n&&(t._spread=this.interpolateArray(t._spread,n))},interpolateArray:function(t,e){for(var r=t.length,i=["function"==typeof t[0].clone?t[0].clone():t[0]],a=(r-1)/(e-1),n=1;n<e-1;++n){var o=n*a,s=Math.floor(o),u=Math.ceil(o),l=o-s;i[n]=this.lerpTypeAgnostic(t[s],t[u],l)}return i.push("function"==typeof t[r-1].clone?t[r-1].clone():t[r-1]),i},clamp:function(t,e,r){return Math.max(e,Math.min(t,r))},zeroToEpsilon:function(t,e){var r=1e-5,i=t;return i=e?Math.random()*r*10:r,t<0&&t>-1e-5&&(i=-i),i},lerpTypeAgnostic:function(t,e,r){var a,n=this.types;return typeof t===n.NUMBER&&typeof e===n.NUMBER?t+(e-t)*r:t instanceof i.Vector2&&e instanceof i.Vector2||typeof t.x==n.NUMBER&&typeof t.y==n.NUMBER&&null==t.z&&null==t.z&&typeof e.x==n.NUMBER&&typeof e.y==n.NUMBER&&null==e.z&&null==e.z?(t instanceof i.Vector2?a=(new i.Vector2).copy(t):((a={}).x=t.x,a.y=t.y),a.x=this.lerp(t.x,e.x,r),a.y=this.lerp(t.y,e.y,r),a):t instanceof i.Vector3&&e instanceof i.Vector3||typeof t.x==n.NUMBER&&typeof t.y==n.NUMBER&&typeof t.z==n.NUMBER&&null==t.w&&null==t.w&&typeof e.x==n.NUMBER&&typeof e.y==n.NUMBER&&typeof e.z==n.NUMBER&&null==e.w&&null==e.w?(t instanceof i.Vector3?a=(new i.Vector3).copy(t):((a={}).x=t.x,a.y=t.y,a.z=t.z),a.x=this.lerp(t.x,e.x,r),a.y=this.lerp(t.y,e.y,r),a.z=this.lerp(t.z,e.z,r),a):t instanceof i.Vector4&&e instanceof i.Vector4||typeof t.x==n.NUMBER&&typeof t.y==n.NUMBER&&typeof t.z==n.NUMBER&&typeof t.w==n.NUMBER&&typeof e.x==n.NUMBER&&typeof e.y==n.NUMBER&&typeof e.z==n.NUMBER&&typeof e.w==n.NUMBER?(t instanceof i.Vector3?a=(new i.Vector4).copy(t):((a={}).x=t.x,a.y=t.y,a.z=t.z,a.w=t.w),a.x=this.lerp(t.x,e.x,r),a.y=this.lerp(t.y,e.y,r),a.z=this.lerp(t.z,e.z,r),a.w=this.lerp(t.w,e.w,r),a):t instanceof i.Color3&&e instanceof i.Color3||typeof t.r==n.NUMBER&&typeof t.g==n.NUMBER&&typeof t.b==n.NUMBER&&typeof e.r==n.NUMBER&&typeof e.g==n.NUMBER&&typeof e.b==n.NUMBER?(t instanceof i.Vector3?a=(new i.Color3).copy(t):((a={}).r=t.r,a.g=t.g,a.b=t.b),a.r=this.lerp(t.r,e.r,r),a.g=this.lerp(t.g,e.g,r),a.b=this.lerp(t.b,e.b,r),a):void console.warn("Invalid argument types, or argument types do not match:",t,e)},lerp:function(t,e,r){return t+(e-t)*r},roundToNearestMultiple:function(t,e){var r;return 0===e||0===(r=Math.abs(t)%e)?t:t<0?-(Math.abs(t)-r):t+e-r},arrayValuesAreEqual:function(t){for(var e=0;e<t.length-1;++e)if(t[e]!==t[e+1])return!1;return!0},randomFloat:function(t,e){return t+e*(Math.random()-.5)},getRandomVector3:function(t,e,r,i,a){var n=r.x+(Math.random()*i.x-.5*i.x),o=r.y+(Math.random()*i.y-.5*i.y),s=r.z+(Math.random()*i.z-.5*i.z);return a&&(n=.5*-a.x+this.roundToNearestMultiple(n,a.x),o=.5*-a.y+this.roundToNearestMultiple(o,a.y),s=.5*-a.z+this.roundToNearestMultiple(s,a.z)),t[e+0]=n,t[e+1]=o,t[e+2]=s,t},getRandomVector3OnSphere:function(t,e,r,i,a,n,o,s){var u=2*Math.random()-1,l=6.2832*Math.random(),c=Math.sqrt(1-u*u),h=this.randomFloat(i,a),p=0,f=0,d=0;return o&&(h=Math.round(h/o)*o),p=c*Math.cos(l)*h,f=c*Math.sin(l)*h,d=u*h,p*=n.x,f*=n.y,d*=n.z,p+=r.x,f+=r.y,d+=r.z,t[e+0]=p,t[e+1]=f,t[e+2]=d,t},getRandomVector3OnDisc:function(t,e,r,i,a,n,o){var s=6.2832*Math.random(),u=Math.abs(this.randomFloat(i,a)),l=0,c=0,h=0;return o&&(u=Math.round(u/o)*o),l=Math.cos(s)*u,c=Math.sin(s)*u,l*=n.x,c*=n.y,l+=r.x,c+=r.y,h+=r.z,t[e+0]=l,t[e+1]=c,t[e+2]=h,t},getRandomVector3OnLine:(c=new i.Vector3,function(t,e,r,i){return c.lerpVectors(r,i,Math.random()),c.toArray(t,e),t}),getRandomDirectionVector3OnSphere:(l=new i.Vector3,function(t,e,r,i,a,n,o,s){return l.copy(n),l.x-=r,l.y-=i,l.z-=a,l.normalize().multiplyScalar(-this.randomFloat(o,s)),l.toArray(t,e),t}),getRandomDirectionVector3OnDisc:function(){var t=new i.Vector3;return function(e,r,i,a,n,o,s,u){return t.copy(o),t.x-=i,t.y-=a,t.z-=n,t.normalize().multiplyScalar(-this.randomFloat(s,u)),t.toArray(e,r),e[r+2]=0,e}}(),getRotationAxis:(u=new i.Vector3,function(t,e,r){return t.copy(e).normalize(),u.copy(r).normalize(),t.x+=.5*-r.x+Math.random()*r.x,t.y+=.5*-r.y+Math.random()*r.y,t.z+=.5*-r.z+Math.random()*r.z,t.normalize(),t})},p=function(){function t(t,e,r,i){this.componentSize=r||1,this.size=e||1,this.TypedArrayConstructor=t||Float32Array,this.array=new t(e*this.componentSize),this.indexOffset=i||0}var e=t.prototype;return e.setSize=function(t,e){var r=this.array.length;return e||(t*=this.componentSize),t<r?this.shrink(t):t>r?this.grow(t):void console.info("TypedArray is already of size:",t+".","Will not resize.")},e.shrink=function(t){return this.array=this.array.subarray(0,t),this.size=t,this},e.grow=function(t){var e=this.array,r=new this.TypedArrayConstructor(t);return r.set(e),this.array=r,this.size=t,this},e.splice=function(t,e){t*=this.componentSize,e*=this.componentSize;for(var r=[],i=this.array,a=i.length,n=0;n<a;++n)(n<t||n>=e)&&r.push(i[n]);return this.setFromArray(0,r),this},e.setFromArray=function(t,e){var r=t+e.length;return r>this.array.length?this.grow(r):r<this.array.length&&this.shrink(r),this.array.set(e,this.indexOffset+t),this},e.setVec2=function(t,e){return this.setVec2Components(t,e.x,e.y)},e.setVec2Components=function(t,e,r){var i=this.array,a=this.indexOffset+t*this.componentSize;return i[a]=e,i[a+1]=r,this},e.setVec3=function(t,e){return this.setVec3Components(t,e.x,e.y,e.z)},e.setVec3Components=function(t,e,r,i){var a=this.array,n=this.indexOffset+t*this.componentSize;return a[n]=e,a[n+1]=r,a[n+2]=i,this},e.setVec4=function(t,e){return this.setVec4Components(t,e.x,e.y,e.z,e.w)},e.setVec4Components=function(t,e,r,i,a){var n=this.array,o=this.indexOffset+t*this.componentSize;return n[o]=e,n[o+1]=r,n[o+2]=i,n[o+3]=a,this},e.setMat3=function(t,e){return this.setFromArray(this.indexOffset+t*this.componentSize,e.elements)},e.setMat4=function(t,e){return this.setFromArray(this.indexOffset+t*this.componentSize,e.elements)},e.setColor=function(t,e){return this.setVec3Components(t,e.r,e.g,e.b)},e.setNumber=function(t,e){return this.array[this.indexOffset+t*this.componentSize]=e,this},e.getValueAtIndex=function(t){return this.array[this.indexOffset+t]},e.getComponentValueAtIndex=function(t){return this.array.subarray(this.indexOffset+t*this.componentSize)},t}(),f={f:1,v2:2,v3:3,v4:4,c:3,m3:9,m4:16},d=function(){function t(t,e,r){var i=f;this.type="string"==typeof t&&i.hasOwnProperty(t)?t:"f",this.componentSize=i[this.type],this.arrayType=r||Float32Array,this.typedArray=null,this.bufferAttribute=null,this.dynamicBuffer=!!e,this.updateMin=0,this.updateMax=0}var e=t.prototype;return e.setUpdateRange=function(t,e){this.updateMin=Math.min(t*this.componentSize,this.updateMin*this.componentSize),this.updateMax=Math.max(e*this.componentSize,this.updateMax*this.componentSize)},e.flagUpdate=function(){var t=this.bufferAttribute,e=t.buffer.updateRange;e.offset=this.updateMin,e.count=Math.min(this.updateMax-this.updateMin+this.componentSize,this.typedArray.array.length),t.buffer.version++},e.resetUpdateRange=function(){this.updateMin=0,this.updateMax=0},e.resetDynamic=function(){this.bufferAttribute.buffer.usage=this.dynamicBuffer?i.BUFFER_USAGE.DYNAMIC_DRAW:i.BUFFER_USAGE.STREAM_DRAW},e.splice=function(t,e){this.typedArray.splice(t,e),this.forceUpdateAll()},e.forceUpdateAll=function(){this.bufferAttribute.buffer.array=this.typedArray.array,this.bufferAttribute.buffer.updateRange.offset=0,this.bufferAttribute.buffer.updateRange.count=-1,this.bufferAttribute.buffer.usage=i.BUFFER_USAGE.STATIC_DRAW,this.bufferAttribute.buffer.version++},e._ensureTypedArray=function(t){null!==this.typedArray&&this.typedArray.size===t*this.componentSize||(null!==this.typedArray&&this.typedArray.size!==t?this.typedArray.setSize(t):null===this.typedArray&&(this.typedArray=new p(this.arrayType,t,this.componentSize)))},e._createBufferAttribute=function(t){if(this._ensureTypedArray(t),null!==this.bufferAttribute)return this.bufferAttribute.buffer.array=this.typedArray.array,this.bufferAttribute.buffer.count=this.bufferAttribute.buffer.array.length/this.bufferAttribute.buffer.stride,void this.bufferAttribute.buffer.version++;this.bufferAttribute=new i.Attribute(new i.Buffer(this.typedArray.array,this.componentSize)),this.bufferAttribute.usage=this.dynamicBuffer?i.BUFFER_USAGE.DYNAMIC_DRAW:i.BUFFER_USAGE.STATIC_DRAW},e.getLength=function(){return null===this.typedArray?0:this.typedArray.array.length},t}(),g={defines:["#define PACKED_COLOR_SIZE 256.0","#define PACKED_COLOR_DIVISOR 255.0"].join("\n"),uniforms:["uniform float deltaTime;","uniform float runTime;","uniform sampler2D tex;","uniform vec4 textureAnimation;","uniform float scale;"].join("\n"),attributes:["attribute vec4 acceleration;","attribute vec3 velocity;","attribute vec4 rotation;","attribute vec3 rotationCenter;","attribute vec4 params;","attribute vec4 size;","attribute vec4 angle;","attribute vec4 color;","attribute vec4 opacity;"].join("\n"),varyings:["varying vec4 vColor;","#ifdef SHOULD_ROTATE_TEXTURE","\t\tvarying float vAngle;","#endif","#ifdef SHOULD_CALCULATE_SPRITE","\t\tvarying vec4 vSpriteSheet;","#endif"].join("\n"),branchAvoidanceFunctions:["float when_gt(float x, float y) {","\t\treturn max(sign(x - y), 0.0);","}","float when_lt(float x, float y) {","\t\treturn min( max(1.0 - sign(x - y), 0.0), 1.0 );","}","float when_eq( float x, float y ) {","\t\treturn 1.0 - abs( sign( x - y ) );","}","float when_ge(float x, float y) {","\treturn 1.0 - when_lt(x, y);","}","float when_le(float x, float y) {","\treturn 1.0 - when_gt(x, y);","}","float and(float a, float b) {","\t\treturn a * b;","}","float or(float a, float b) {","\t\treturn min(a + b, 1.0);","}"].join("\n"),unpackColor:["vec3 unpackColor( in float hex ) {","\t vec3 c = vec3( 0.0 );","\t float r = mod( (hex / PACKED_COLOR_SIZE / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","\t float g = mod( (hex / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","\t float b = mod( hex, PACKED_COLOR_SIZE );","\t c.r = r / PACKED_COLOR_DIVISOR;","\t c.g = g / PACKED_COLOR_DIVISOR;","\t c.b = b / PACKED_COLOR_DIVISOR;","\t return c;","}"].join("\n"),unpackRotationAxis:["vec3 unpackRotationAxis( in float hex ) {","\t vec3 c = vec3( 0.0 );","\t float r = mod( (hex / PACKED_COLOR_SIZE / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","\t float g = mod( (hex / PACKED_COLOR_SIZE), PACKED_COLOR_SIZE );","\t float b = mod( hex, PACKED_COLOR_SIZE );","\t c.r = r / PACKED_COLOR_DIVISOR;","\t c.g = g / PACKED_COLOR_DIVISOR;","\t c.b = b / PACKED_COLOR_DIVISOR;","\t c *= vec3( 2.0 );","\t c -= vec3( 1.0 );","\t return c;","}"].join("\n"),floatOverLifetime:["float getFloatOverLifetime( in float positionInTime, in vec4 attr ) {","\t\thighp float value = 0.0;","\t\tfloat deltaAge = positionInTime * float( VALUE_OVER_LIFETIME_LENGTH - 1 );","\t\tfloat fIndex = 0.0;","\t\tfloat shouldApplyValue = 0.0;","\t\tvalue += attr[ 0 ] * when_eq( deltaAge, 0.0 );","","\t\tfor( int i = 0; i < VALUE_OVER_LIFETIME_LENGTH - 1; ++i ) {","\t\t\t fIndex = float( i );","\t\t\t shouldApplyValue = and( when_gt( deltaAge, fIndex ), when_le( deltaAge, fIndex + 1.0 ) );","\t\t\t value += shouldApplyValue * mix( attr[ i ], attr[ i + 1 ], deltaAge - fIndex );","\t\t}","","\t\treturn value;","}"].join("\n"),colorOverLifetime:["vec3 getColorOverLifetime( in float positionInTime, in vec3 color1, in vec3 color2, in vec3 color3, in vec3 color4 ) {","\t\tvec3 value = vec3( 0.0 );","\t\tvalue.x = getFloatOverLifetime( positionInTime, vec4( color1.x, color2.x, color3.x, color4.x ) );","\t\tvalue.y = getFloatOverLifetime( positionInTime, vec4( color1.y, color2.y, color3.y, color4.y ) );","\t\tvalue.z = getFloatOverLifetime( positionInTime, vec4( color1.z, color2.z, color3.z, color4.z ) );","\t\treturn value;","}"].join("\n"),paramFetchingFunctions:["float getAlive() {","\t return params.x;","}","float getAge() {","\t return params.y;","}","float getMaxAge() {","\t return params.z;","}","float getWiggle() {","\t return params.w;","}"].join("\n"),forceFetchingFunctions:["vec4 getPosition( in float age ) {","\t return u_View * u_Model * vec4( a_Position, 1.0 );","}","vec3 getVelocity( in float age ) {","\t return velocity * age;","}","vec3 getAcceleration( in float age ) {","\t return acceleration.xyz * age;","}"].join("\n"),rotationFunctions:["#ifdef SHOULD_ROTATE_PARTICLES","\t mat4 getRotationMatrix( in vec3 axis, in float angle) {","\t\t\t axis = normalize(axis);","\t\t\t float s = sin(angle);","\t\t\t float c = cos(angle);","\t\t\t float oc = 1.0 - c;","","\t\t\t return mat4(oc * axis.x * axis.x + c,\t\t\t\t\t oc * axis.x * axis.y - axis.z * s,\toc * axis.z * axis.x + axis.y * s,\t0.0,","\t\t\t\t\t\t\t\t\t oc * axis.x * axis.y + axis.z * s,\toc * axis.y * axis.y + c,\t\t\t\t\t oc * axis.y * axis.z - axis.x * s,\t0.0,","\t\t\t\t\t\t\t\t\t oc * axis.z * axis.x - axis.y * s,\toc * axis.y * axis.z + axis.x * s,\toc * axis.z * axis.z + c,\t\t\t\t\t 0.0,","\t\t\t\t\t\t\t\t\t 0.0,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t0.0,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t0.0,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t1.0);","\t }","","\t vec3 getRotation( in vec3 pos, in float positionInTime ) {","\t\t\tif( rotation.y == 0.0 ) {","\t\t\t\t\t return pos;","\t\t\t}","","\t\t\tvec3 axis = unpackRotationAxis( rotation.x );","\t\t\tvec3 center = rotationCenter;","\t\t\tvec3 translated;","\t\t\tmat4 rotationMatrix;","\t\t\tfloat angle = 0.0;","\t\t\tangle += when_eq( rotation.z, 0.0 ) * rotation.y;","\t\t\tangle += when_gt( rotation.z, 0.0 ) * mix( 0.0, rotation.y, positionInTime );","\t\t\ttranslated = rotationCenter - pos;","\t\t\trotationMatrix = getRotationMatrix( axis, angle );","\t\t\treturn center - vec3( rotationMatrix * vec4( translated, 0.0 ) );","\t }","#endif"].join("\n"),rotateTexture:["\t\tvec2 vUv = vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y );","","\t\t#ifdef SHOULD_ROTATE_TEXTURE","\t\t\t float x = gl_PointCoord.x - 0.5;","\t\t\t float y = 1.0 - gl_PointCoord.y - 0.5;","\t\t\t float c = cos( -vAngle );","\t\t\t float s = sin( -vAngle );","\t\t\t vUv = vec2( c * x + s * y + 0.5, c * y - s * x + 0.5 );","\t\t#endif","","\t\t#ifdef SHOULD_CALCULATE_SPRITE","\t\t\t\tfloat framesX = vSpriteSheet.x;","\t\t\t\tfloat framesY = vSpriteSheet.y;","\t\t\t\tfloat columnNorm = vSpriteSheet.z;","\t\t\t\tfloat rowNorm = vSpriteSheet.w;","\t\t\t\tvUv.x = gl_PointCoord.x * framesX + columnNorm;","\t\t\t\tvUv.y = 1.0 - (gl_PointCoord.y * framesY + rowNorm);","\t\t#endif","","\t\tvec4 rotatedTexture = texture2D( tex, vUv );"].join("\n")},m={vertex:[g.defines,g.uniforms,g.attributes,g.varyings,i.ShaderChunk.common_vert,i.ShaderChunk.logdepthbuf_pars_vert,g.branchAvoidanceFunctions,g.unpackColor,g.unpackRotationAxis,g.floatOverLifetime,g.colorOverLifetime,g.paramFetchingFunctions,g.forceFetchingFunctions,g.rotationFunctions,"void main() {","\t\thighp float age = getAge();","\t\thighp float alive = getAlive();","\t\thighp float maxAge = getMaxAge();","\t\thighp float positionInTime = (age / maxAge);","\t\thighp float isAlive = when_gt( alive, 0.0 );","\t\t#ifdef SHOULD_WIGGLE_PARTICLES","\t\t\t\tfloat wiggleAmount = positionInTime * getWiggle();","\t\t\t\tfloat wiggleSin = isAlive * sin( wiggleAmount );","\t\t\t\tfloat wiggleCos = isAlive * cos( wiggleAmount );","\t\t#endif","\t\tvec3 vel = getVelocity( age );","\t\tvec3 accel = getAcceleration( age );","\t\tvec3 force = vec3( 0.0 );","\t\tvec3 pos = vec3( a_Position );","\t\tfloat drag = 1.0 - (positionInTime * 0.5) * acceleration.w;","\t\tforce += vel;","\t\tforce *= drag;","\t\tforce += accel * age;","\t\tpos += force;","\t\t#ifdef SHOULD_WIGGLE_PARTICLES","\t\t\t\tpos.x += wiggleSin;","\t\t\t\tpos.y += wiggleCos;","\t\t\t\tpos.z += wiggleSin;","\t\t#endif","\t\t#ifdef SHOULD_ROTATE_PARTICLES","\t\t\t\tpos = getRotation( pos, positionInTime );","\t\t#endif","\t\tvec4 mvPosition = u_View * u_Model * vec4( pos, 1.0 );","\t\thighp float pointSize = getFloatOverLifetime( positionInTime, size ) * isAlive;","\t\t#ifdef HAS_PERSPECTIVE","\t\t\t\tfloat perspective = scale / length( mvPosition.xyz );","\t\t#else","\t\t\t\tfloat perspective = 1.0;","\t\t#endif","\t\tfloat pointSizePerspective = pointSize * perspective;","\t\t#ifdef COLORIZE","\t\t\t vec3 c = isAlive * getColorOverLifetime(","\t\t\t\t\t positionInTime,","\t\t\t\t\t unpackColor( color.x ),","\t\t\t\t\t unpackColor( color.y ),","\t\t\t\t\t unpackColor( color.z ),","\t\t\t\t\t unpackColor( color.w )","\t\t\t );","\t\t#else","\t\t\t vec3 c = vec3(1.0);","\t\t#endif","\t\tfloat o = isAlive * getFloatOverLifetime( positionInTime, opacity );","\t\tvColor = vec4( c, o );","\t\t#ifdef SHOULD_ROTATE_TEXTURE","\t\t\t\tvAngle = isAlive * getFloatOverLifetime( positionInTime, angle );","\t\t#endif","\t\t#ifdef SHOULD_CALCULATE_SPRITE","\t\t\t\tfloat framesX = textureAnimation.x;","\t\t\t\tfloat framesY = textureAnimation.y;","\t\t\t\tfloat loopCount = textureAnimation.w;","\t\t\t\tfloat totalFrames = textureAnimation.z;","\t\t\t\tfloat frameNumber = mod( (positionInTime * loopCount) * totalFrames, totalFrames );","\t\t\t\tfloat column = floor(mod( frameNumber, framesX ));","\t\t\t\tfloat row = floor( (frameNumber - column) / framesX );","\t\t\t\tfloat columnNorm = column / framesX;","\t\t\t\tfloat rowNorm = row / framesY;","\t\t\t\tvSpriteSheet.x = 1.0 / framesX;","\t\t\t\tvSpriteSheet.y = 1.0 / framesY;","\t\t\t\tvSpriteSheet.z = columnNorm;","\t\t\t\tvSpriteSheet.w = rowNorm;","\t\t#endif","\t\tgl_PointSize = pointSizePerspective;","\t\tgl_Position = u_Projection * mvPosition;",i.ShaderChunk.logdepthbuf_vert,"}"].join("\n"),fragment:[g.uniforms,i.ShaderChunk.common_frag,i.ShaderChunk.fog_pars_frag,i.ShaderChunk.logdepthbuf_pars_frag,g.varyings,g.branchAvoidanceFunctions,"void main() {","\t\tvec3 outgoingLight = vColor.xyz;","\t\t","\t\t#ifdef ALPHATEST","\t\t\t if ( vColor.w < float(ALPHATEST) ) discard;","\t\t#endif",g.rotateTexture,i.ShaderChunk.logdepthbuf_frag,"\t\toutgoingLight = vColor.xyz * rotatedTexture.xyz;","\t\tgl_FragColor = vec4( outgoingLight.xyz, rotatedTexture.w * vColor.w );",i.ShaderChunk.fog_frag,"}"].join("\n")},y=function(){function t(t){this.uuid=i.generateUUID();var e=h.types,r=a.valueOverLifetimeLength;for(var n in(t=h.ensureTypedArg(t,e.OBJECT,{})).position=h.ensureTypedArg(t.position,e.OBJECT,{}),t.velocity=h.ensureTypedArg(t.velocity,e.OBJECT,{}),t.acceleration=h.ensureTypedArg(t.acceleration,e.OBJECT,{}),t.radius=h.ensureTypedArg(t.radius,e.OBJECT,{}),t.drag=h.ensureTypedArg(t.drag,e.OBJECT,{}),t.rotation=h.ensureTypedArg(t.rotation,e.OBJECT,{}),t.color=h.ensureTypedArg(t.color,e.OBJECT,{}),t.opacity=h.ensureTypedArg(t.opacity,e.OBJECT,{}),t.size=h.ensureTypedArg(t.size,e.OBJECT,{}),t.angle=h.ensureTypedArg(t.angle,e.OBJECT,{}),t.wiggle=h.ensureTypedArg(t.wiggle,e.OBJECT,{}),t.maxAge=h.ensureTypedArg(t.maxAge,e.OBJECT,{}),this.type=h.ensureTypedArg(t.type,e.NUMBER,a.distributions.BOX),this.position={_value:h.ensureInstanceOf(t.position.value,i.Vector3,new i.Vector3),_spread:h.ensureInstanceOf(t.position.spread,i.Vector3,new i.Vector3),_spreadClamp:h.ensureInstanceOf(t.position.spreadClamp,i.Vector3,new i.Vector3),_distribution:h.ensureTypedArg(t.position.distribution,e.NUMBER,this.type),_randomise:h.ensureTypedArg(t.position.randomise,e.BOOLEAN,!1),_radius:h.ensureTypedArg(t.position.radius,e.NUMBER,10),_radiusScale:h.ensureInstanceOf(t.position.radiusScale,i.Vector3,new i.Vector3(1,1,1))},this.velocity={_value:h.ensureInstanceOf(t.velocity.value,i.Vector3,new i.Vector3),_spread:h.ensureInstanceOf(t.velocity.spread,i.Vector3,new i.Vector3),_distribution:h.ensureTypedArg(t.velocity.distribution,e.NUMBER,this.type),_randomise:h.ensureTypedArg(t.velocity.randomise,e.BOOLEAN,!1)},this.acceleration={_value:h.ensureInstanceOf(t.acceleration.value,i.Vector3,new i.Vector3),_spread:h.ensureInstanceOf(t.acceleration.spread,i.Vector3,new i.Vector3),_distribution:h.ensureTypedArg(t.acceleration.distribution,e.NUMBER,this.type),_randomise:h.ensureTypedArg(t.acceleration.randomise,e.BOOLEAN,!1)},this.drag={_value:h.ensureTypedArg(t.drag.value,e.NUMBER,0),_spread:h.ensureTypedArg(t.drag.spread,e.NUMBER,0),_randomise:h.ensureTypedArg(t.drag.randomise,e.BOOLEAN,!1)},this.wiggle={_value:h.ensureTypedArg(t.wiggle.value,e.NUMBER,0),_spread:h.ensureTypedArg(t.wiggle.spread,e.NUMBER,0)},this.rotation={_axis:h.ensureInstanceOf(t.rotation.axis,i.Vector3,new i.Vector3(0,1,0)),_axisSpread:h.ensureInstanceOf(t.rotation.axisSpread,i.Vector3,new i.Vector3),_angle:h.ensureTypedArg(t.rotation.angle,e.NUMBER,0),_angleSpread:h.ensureTypedArg(t.rotation.angleSpread,e.NUMBER,0),_static:h.ensureTypedArg(t.rotation.static,e.BOOLEAN,!1),_center:h.ensureInstanceOf(t.rotation.center,i.Vector3,this.position._value.clone()),_randomise:h.ensureTypedArg(t.rotation.randomise,e.BOOLEAN,!1)},this.maxAge={_value:h.ensureTypedArg(t.maxAge.value,e.NUMBER,2),_spread:h.ensureTypedArg(t.maxAge.spread,e.NUMBER,0)},this.color={_value:h.ensureArrayInstanceOf(t.color.value,i.Color3,new i.Color3(1,1,1)),_spread:h.ensureArrayInstanceOf(t.color.spread,i.Vector3,new i.Vector3),_randomise:h.ensureTypedArg(t.color.randomise,e.BOOLEAN,!1)},this.opacity={_value:h.ensureArrayTypedArg(t.opacity.value,e.NUMBER,1),_spread:h.ensureArrayTypedArg(t.opacity.spread,e.NUMBER,0),_randomise:h.ensureTypedArg(t.opacity.randomise,e.BOOLEAN,!1)},this.size={_value:h.ensureArrayTypedArg(t.size.value,e.NUMBER,1),_spread:h.ensureArrayTypedArg(t.size.spread,e.NUMBER,0),_randomise:h.ensureTypedArg(t.size.randomise,e.BOOLEAN,!1)},this.angle={_value:h.ensureArrayTypedArg(t.angle.value,e.NUMBER,0),_spread:h.ensureArrayTypedArg(t.angle.spread,e.NUMBER,0),_randomise:h.ensureTypedArg(t.angle.randomise,e.BOOLEAN,!1)},this.resetFlags={position:h.ensureTypedArg(t.position.randomise,e.BOOLEAN,!1)||h.ensureTypedArg(t.radius.randomise,e.BOOLEAN,!1),velocity:h.ensureTypedArg(t.velocity.randomise,e.BOOLEAN,!1),acceleration:h.ensureTypedArg(t.acceleration.randomise,e.BOOLEAN,!1)||h.ensureTypedArg(t.drag.randomise,e.BOOLEAN,!1),rotation:h.ensureTypedArg(t.rotation.randomise,e.BOOLEAN,!1),size:h.ensureTypedArg(t.size.randomise,e.BOOLEAN,!1),color:h.ensureTypedArg(t.color.randomise,e.BOOLEAN,!1),opacity:h.ensureTypedArg(t.opacity.randomise,e.BOOLEAN,!1),angle:h.ensureTypedArg(t.angle.randomise,e.BOOLEAN,!1)},this.updateFlags={},this.updateCounts={},this.updateMap={maxAge:"params",position:"position",velocity:"velocity",acceleration:"acceleration",drag:"acceleration",wiggle:"params",rotation:"rotation",size:"size",color:"color",opacity:"opacity",angle:"angle"},this.updateMap)this.updateMap.hasOwnProperty(n)&&(this.updateCounts[this.updateMap[n]]=0,this.updateFlags[this.updateMap[n]]=!1,this._createGetterSetters(this[n],n));h.ensureValueOverLifetimeCompliance(this.color,r,r),h.ensureValueOverLifetimeCompliance(this.opacity,r,r),h.ensureValueOverLifetimeCompliance(this.size,r,r),h.ensureValueOverLifetimeCompliance(this.angle,r,r),this.particleCount=h.ensureTypedArg(t.particleCount,e.NUMBER,100),this.duration=h.ensureTypedArg(t.duration,e.NUMBER,null),this.isStatic=h.ensureTypedArg(t.isStatic,e.BOOLEAN,!1),this.activeMultiplier=h.ensureTypedArg(t.activeMultiplier,e.NUMBER,1),this.direction=h.ensureTypedArg(t.direction,e.NUMBER,1),this.isLookAtCamera=h.ensureTypedArg(t.isLookAtCamera,e.BOOLEAN,!1),this.isLookAtCameraOnlyY=h.ensureTypedArg(t.isLookAtCameraOnlyY,e.BOOLEAN,!1),this.alive=h.ensureTypedArg(t.alive,e.BOOLEAN,!0),this.particlesPerSecond=0,this.calculatePPSValue(),this.age=0,this.group=null}var e=t.prototype;return e._createGetterSetters=function(t,e){var r=this;for(var i in t)if(t.hasOwnProperty(i)){var n=i.replace("_","");Object.defineProperty(t,n,{get:function(t){return function(){return this[t]}}(i),set:function(t){return function(i){var n=r.updateMap[e],o=this[t],s=a.valueOverLifetimeLength;"_randomise"===t?r.resetFlags[n]=i:(r.updateFlags[n]=!0,r.updateCounts[n]=0),this[t]=i,r.group.$updateDefines(r),Array.isArray(o)&&h.ensureValueOverLifetimeCompliance(r[e],s,s)}}(i)})}},e.calculatePPSValue=function(){var t=this.particleCount,e=this.maxAge._value+Math.abs(.5*this.maxAge._spread);return null!==this.duration?this.particlesPerSecond=t/Math.min(e,this.duration):this.particlesPerSecond=t/e,this},e.enable=function(){return this.alive=!0,this},e.disable=function(){return this.alive=!1,this},e.remove=function(){return null!==this.group?this.group.removeEmitter(this):console.error("Emitter does not belong to a group, cannot remove."),this},e.reset=function(t){},e._assignValue=function(){},e._assignPositionValue=function(t,e){var r=a.distributions,i=this.position,n=i._value,o=i._spread;switch(i._distribution){case r.BOX:h.getRandomVector3(t,e,n,o,i._spreadClamp);break;case r.SPHERE:h.getRandomVector3OnSphere(t,e,n,i._radius,i._spread.x,i._radiusScale,i._spreadClamp.x,i._distributionClamp||this.particleCount);break;case r.DISC:h.getRandomVector3OnDisc(t,e,n,i._radius,i._spread.x,i._radiusScale,i._spreadClamp.x);break;case r.LINE:h.getRandomVector3OnLine(t,e,n,o)}return t},e._assignForceValue=function(t,e,r,i){var n=a.distributions,o=this[r],s=o._value,u=o._spread;switch(o._distribution){case n.BOX:h.getRandomVector3(t,e,s,u);break;case n.SPHERE:h.getRandomDirectionVector3OnSphere(t,e,i[0],i[1],i[2],this.position.value,s.x,u.x);break;case n.DISC:h.getRandomDirectionVector3OnDisc(t,e,i[0],i[1],i[2],this.position.value,s.x,u.x);break;case n.LINE:h.getRandomVector3OnLine(t,e,s,u)}if("acceleration"===r){var l=h.clamp(h.randomFloat(this.drag._value,this.drag._spread),0,1);t[e+3]=l}return t},e._assignAbsLifetimeValue=function(t,e,r){var i=this[r];if(h.arrayValuesAreEqual(i._value)&&h.arrayValuesAreEqual(i._spread)){var a=Math.abs(h.randomFloat(i._value[0],i._spread[0]));t[e+0]=a,t[e+1]=a,t[e+2]=a,t[e+3]=a}else t[e+0]=Math.abs(h.randomFloat(i._value[0],i._spread[0])),t[e+1]=Math.abs(h.randomFloat(i._value[1],i._spread[1])),t[e+2]=Math.abs(h.randomFloat(i._value[2],i._spread[2])),t[e+3]=Math.abs(h.randomFloat(i._value[3],i._spread[3]));return t},e._assignAngleValue=function(t,e){var r=this.angle;if(h.arrayValuesAreEqual(r._value)&&h.arrayValuesAreEqual(r._spread)){var i=h.randomFloat(r._value[0],r._spread[0]);t[e+0]=i,t[e+1]=i,t[e+2]=i,t[e+3]=i}else t[e+0]=h.randomFloat(r._value[0],r._spread[0]),t[e+1]=h.randomFloat(r._value[1],r._spread[1]),t[e+2]=h.randomFloat(r._value[2],r._spread[2]),t[e+3]=h.randomFloat(r._value[3],r._spread[3]);return t},e._assignParamsValue=function(t,e,r){return t[e+0]=r?this.isStatic?1:0:1,t[e+1]=0,t[e+2]=h.randomFloat(this.maxAge._value,this.maxAge._spread),t[e+3]=h.randomFloat(this.wiggle._value,this.wiggle._spread),t},e._assignRotationValue=function(t,e,r,i,a){var n=h.getRotationAxis(_,this.rotation._axis,this.rotation._axisSpread);a?(n.x+=1,n.y+=1,n.z+=1,n.multiplyScalar(.5),v.setRGB(n.x,n.y,n.z),t[e+0]=v.getHex(),t[e+1]=h.randomFloat(this.rotation._angle,this.rotation._angleSpread),t[e+2]=this.rotation._static?0:1):(t[e+0]=n.x,t[e+1]=n.y,t[e+2]=n.z,t[e+3]=h.randomFloat(this.rotation._angle,this.rotation._angleSpread),t[e+4]=this.rotation._static?0:1),this.rotation._center.toArray(r,i)},e._assignColorValue=function(t,e,r){for(var i=this.color._value,a=this.color._spread,n=i.length,o=0;o<n;++o){var s=a[o];v.copy(i[o]),v.r+=Math.random()*s.x-.5*s.x,v.g+=Math.random()*s.y-.5*s.y,v.b+=Math.random()*s.z-.5*s.z,v.r=h.clamp(v.r,0,1),v.g=h.clamp(v.g,0,1),v.b=h.clamp(v.b,0,1),r?t[e+o]=v.getHex():v.toArray(t,e+3*o)}},t}(),_=new i.Vector3,v=new i.Color3,A=function(t){function e(e){var r;return(r=t.call(this,e)||this).activationIndex=0,r.attributeOffset=0,r.attributeEnd=0,r.activeParticleCount=0,r.attributes=null,r.paramsArray=null,r.bufferUpdateRanges={},r.attributeKeys=null,r.attributeCount=0,r}o(e,t);var r=e.prototype;return r.tick=function(t){if(!this.isStatic){null===this.paramsArray&&(this.paramsArray=this.attributes.params.typedArray.array);var e=this.attributeOffset,r=e+this.particleCount,i=this.paramsArray,a=this.particlesPerSecond*this.activeMultiplier*t,n=this.activationIndex;if(this._resetBufferRanges(),this._checkParticleAges(e,r,i,t),!1!==this.alive){if(null!==this.duration&&this.age>this.duration)return this.alive=!1,void(this.age=0);var o=1===this.particleCount?n:0|n,s=Math.min(o+a,this.activationEnd),u=s-this.activationIndex|0,l=u>0?t/u:0;this._activateParticles(o,s,i,l),this.activationIndex+=a,this.activationIndex>r&&(this.activationIndex=e),this.age+=t}else this.age=0}},r.reset=function(t){if(this.age=0,this.alive=!1,!0===t){for(var e,r=this.attributeOffset,i=r+this.particleCount,a=this.paramsArray,n=this.attributes.params.bufferAttribute,o=i-1;o>=r;--o)a[e=4*o]=0,a[e+1]=0;n.updateRange.offset=0,n.updateRange.count=-1,n.needsUpdate=!0}return this},r._assignValue=function(t,e){var r,i,a,n,o;switch(t){case"position":r=this.attributes.position.typedArray,this._assignPositionValue(r.array,r.componentSize*e);break;case"velocity":case"acceleration":a=(r=this.attributes.position.typedArray).array[3*e+0],n=r.array[3*e+1],o=r.array[3*e+2],r=this.attributes[t].typedArray,this._assignForceValue(r.array,r.componentSize*e,t,[a,n,o]);break;case"size":case"opacity":r=this.attributes[t].typedArray,this._assignAbsLifetimeValue(r.array,r.componentSize*e,t);break;case"angle":r=this.attributes.angle.typedArray,this._assignAngleValue(r.array,r.componentSize*e);break;case"params":r=this.attributes.params.typedArray,this._assignParamsValue(r.array,r.componentSize*e,!0);break;case"rotation":r=this.attributes.rotation.typedArray,i=this.attributes.rotationCenter.typedArray,this._assignRotationValue(r.array,r.componentSize*e,i.array,i.componentSize*e,!0);break;case"color":r=this.attributes.color.typedArray,this._assignColorValue(r.array,r.componentSize*e,!0)}},r._resetParticle=function(t){for(var e,r,i=this.resetFlags,a=this.updateFlags,n=this.updateCounts,o=this.attributeKeys,s=this.attributeCount-1;s>=0;--s)r=a[e=o[s]],!0!==i[e]&&!0!==r||(this._assignValue(e,t),this._updateAttributeUpdateRange(e,t),!0===r&&n[e]===this.particleCount?(a[e]=!1,n[e]=0):1==r&&++n[e])},r._setBufferUpdateRanges=function(t){this.attributeKeys=t,this.attributeCount=t.length;for(var e=this.attributeCount-1;e>=0;--e)this.bufferUpdateRanges[t[e]]={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY}},r._setAttributeOffset=function(t){this.attributeOffset=t,this.activationIndex=t,this.activationEnd=t+this.particleCount},r._updateAttributeUpdateRange=function(t,e){var r=this.bufferUpdateRanges[t];r.min=Math.min(e,r.min),r.max=Math.max(e,r.max)},r._resetBufferRanges=function(){for(var t,e=this.bufferUpdateRanges,r=this.bufferUpdateKeys,i=this.bufferUpdateCount-1;i>=0;--i)e[t=r[i]].min=Number.POSITIVE_INFINITY,e[t].max=Number.NEGATIVE_INFINITY},r._onRemove=function(){this.particlesPerSecond=0,this.attributeOffset=0,this.activationIndex=0,this.activeParticleCount=0,this.group=null,this.attributes=null,this.paramsArray=null,this.age=0},r._decrementParticleCount=function(){--this.activeParticleCount},r._incrementParticleCount=function(){++this.activeParticleCount},r._checkParticleAges=function(t,e,r,i){for(var a,n,o,s,u=e-1;u>=t;--u)0!==(s=r[a=4*u])&&(o=r[a+1],n=r[a+2],1===this.direction?(o+=i)>=n&&(o=0,s=0,this._decrementParticleCount()):(o-=i)<=0&&(o=n,s=0,this._decrementParticleCount()),r[a]=s,r[a+1]=o,this._updateAttributeUpdateRange("params",u))},r._activateParticles=function(t,e,r,i){for(var a,n,o=this.direction,s=t;s<e;++s)0!=r[a=4*s]&&1!==this.particleCount||(this._incrementParticleCount(),r[a]=1,this._resetParticle(s),(n=i*(s-t))<=r[a+1]&&(r[a+1]=-1===o?r[a+2]-n:n),this._updateAttributeUpdateRange("params",s))},e}(y),x=function(){function t(t){this.uuid=i.generateUUID();var e=h.types;t.texture=h.ensureTypedArg(t.texture,e.OBJECT,{}),this.fixedTimeStep=h.ensureTypedArg(t.fixedTimeStep,e.NUMBER,.016),this.hasPerspective=h.ensureTypedArg(t.hasPerspective,e.BOOLEAN,!0),this.colorize=h.ensureTypedArg(t.colorize,e.BOOLEAN,!0),this._emitters=[]}var e=t.prototype;return e.addEmitter=function(t){},e.removeEmitter=function(t){},e.tick=function(t){},e.dispose=function(){},e._setMaterial=function(t,e){var r=h.types;t.uniforms.tex=h.ensureInstanceOf(e.texture.value,i.Texture2D,E),t.blending=h.ensureTypedArg(e.blending,r.STRING,i.BLEND_TYPE.ADD),t.transparent=h.ensureTypedArg(e.transparent,r.BOOLEAN,!0),t.alphaTest=h.ensureTypedArg(e.alphaTest,r.NUMBER,0),t.depthWrite=h.ensureTypedArg(e.depthWrite,r.BOOLEAN,!1),t.depthTest=h.ensureTypedArg(e.depthTest,r.BOOLEAN,!0),t.fog=h.ensureTypedArg(e.fog,r.BOOLEAN,!0)},t}(),E=new i.Texture2D;E.image={data:new Uint8Array([255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255]),width:2,height:2},E.magFilter=i.TEXTURE_FILTER.NEAREST,E.minFilter=i.TEXTURE_FILTER.NEAREST,E.generateMipmaps=!1;var b=function(t){function e(e){var r,n=h,o=n.types;return e=h.ensureTypedArg(e,o.OBJECT,{}),(r=t.call(this,e)||this).maxParticleCount=n.ensureTypedArg(e.maxParticleCount,o.NUMBER,null),null===r.maxParticleCount&&console.warn("ParticleGroup: No maxParticleCount specified. Adding emitters after rendering will probably cause errors."),r.textureFrames=h.ensureInstanceOf(e.texture.frames,i.Vector2,new i.Vector2(1,1)),r.textureFrames.max(new i.Vector2(1,1)),r.textureFrameCount=h.ensureTypedArg(e.texture.frameCount,o.NUMBER,r.textureFrames.x*r.textureFrames.y),r.textureLoop=h.ensureTypedArg(e.texture.loop,o.NUMBER,1),r.material=new i.ShaderMaterial({defines:{HAS_PERSPECTIVE:r.hasPerspective,COLORIZE:r.colorize,VALUE_OVER_LIFETIME_LENGTH:a.valueOverLifetimeLength,SHOULD_ROTATE_TEXTURE:!1,SHOULD_ROTATE_PARTICLES:!1,SHOULD_WIGGLE_PARTICLES:!1,SHOULD_CALCULATE_SPRITE:r.textureFrames.x>1||r.textureFrames.y>1},uniforms:{tex:null,textureAnimation:[r.textureFrames.x,r.textureFrames.y,r.textureFrameCount,Math.max(Math.abs(r.textureLoop),1)],scale:n.ensureTypedArg(e.scale,o.NUMBER,300),deltaTime:0,runTime:0},vertexShader:m.vertex,fragmentShader:m.fragment}),r._setMaterial(r.material,e),r.material.drawMode=i.DRAW_MODE.POINTS,r.uniforms=r.material.uniforms,r.defines=r.material.defines,r.geometry=new i.Geometry,r.geometry.addGroup(0,r.particleCount,0),r.mesh=new i.Mesh(r.geometry,[r.material]),r.mesh.frustumCulled=!1,r.attributes={position:new d("v3",!0),acceleration:new d("v4",!0),velocity:new d("v3",!0),rotation:new d("v4",!0),rotationCenter:new d("v3",!0),params:new d("v4",!0),size:new d("v4",!0),angle:new d("v4",!0),color:new d("v4",!0),opacity:new d("v4",!0)},r.attributeKeys=Object.keys(r.attributes),r.attributeCount=r.attributeKeys.length,r._attributesNeedRefresh=!1,r._attributesNeedDynamicReset=!1,r.particleCount=0,r}o(e,t);var r=e.prototype;return r.addEmitter=function(t){if(t instanceof A!=!1)if(this._emitters.indexOf(t)>-1)console.error("ParticleEmitter already exists in this group. Will not add again.");else{if(null===t.group){var e=this.attributes,r=this.particleCount,i=r+t.particleCount;for(var a in this.particleCount=i,null!==this.maxParticleCount&&this.particleCount>this.maxParticleCount&&console.warn("ParticleGroup: maxParticleCount exceeded. Requesting",this.particleCount,"particles, can support only",this.maxParticleCount),t._setBufferUpdateRanges(this.attributeKeys),t._setAttributeOffset(r),t.group=this,t.attributes=this.attributes,e)e.hasOwnProperty(a)&&e[a]._createBufferAttribute(null!==this.maxParticleCount?this.maxParticleCount:this.particleCount);for(var n=r;n<i;++n)t._assignValue("position",n),t._assignValue("velocity",n),t._assignValue("acceleration",n),t._assignValue("size",n),t._assignValue("opacity",n),t._assignValue("angle",n),t._assignValue("params",n),t._assignValue("rotation",n),t._assignValue("color",n);return this._applyAttributesToGeometry(),this._emitters.push(t),this.$updateDefines(t),this._attributesNeedRefresh=!0,this}console.error("ParticleEmitter already belongs to another group. Will not add to requested group.")}else console.error("`emitter` argument must be instance of ParticleEmitter. Was provided with:",t)},r.removeEmitter=function(t){var e=this._emitters.indexOf(t);if(t instanceof A!=!1)if(-1!==e){for(var r=t.attributeOffset,i=r+t.particleCount,a=this.attributes.params.typedArray,n=r;n<i;++n)a.array[4*n]=0,a.array[4*n+1]=0;for(var o in this._emitters.splice(e,1),this.attributes)this.attributes.hasOwnProperty(o)&&this.attributes[o].splice(r,i);this.particleCount-=t.particleCount,t._onRemove(),this._attributesNeedRefresh=!0}else console.error("ParticleEmitter does not exist in this group. Will not remove.");else console.error("`emitter` argument must be instance of ParticleEmitter. Was provided with:",t)},r.tick=function(t){var e,r,i=this._emitters,a=i.length,n=t||this.fixedTimeStep,o=this.attributeKeys,s=this.attributes;for(this.uniforms.runTime+=n,this.uniforms.deltaTime=n,e=this.attributeCount-1;e>=0;--e)s[o[e]].resetUpdateRange();if(0!==a||!1!==this._attributesNeedRefresh||!1!==this._attributesNeedDynamicReset){for(r=0;r<a;++r){var u=i[r];u.tick(n);var l=u.bufferUpdateRanges,c=void 0,h=void 0,p=void 0;for(e=this.attributeCount-1;e>=0;--e)h=l[c=o[e]],(p=s[c]).setUpdateRange(h.min,h.max),p.flagUpdate()}if(!0===this._attributesNeedDynamicReset){for(e=this.attributeCount-1;e>=0;--e)s[o[e]].resetDynamic();this._attributesNeedDynamicReset=!1}if(!0===this._attributesNeedRefresh){for(e=this.attributeCount-1;e>=0;--e)s[o[e]].forceUpdateAll();this._attributesNeedRefresh=!1,this._attributesNeedDynamicReset=!0}}},r.dispose=function(){return this.mesh.geometry.dispose(),this.mesh.material[0].dispose(),this},r.$updateDefines=function(){for(var t,e=this._emitters,r=this.defines,i=e.length-1;i>=0;--i)t=e[i],r.SHOULD_CALCULATE_SPRITE||(r.SHOULD_ROTATE_TEXTURE=r.SHOULD_ROTATE_TEXTURE||!!Math.max(Math.max.apply(null,t.angle.value),Math.max.apply(null,t.angle.spread))),r.SHOULD_ROTATE_PARTICLES=r.SHOULD_ROTATE_PARTICLES||!!Math.max(t.rotation.angle,t.rotation.angleSpread),r.SHOULD_WIGGLE_PARTICLES=r.SHOULD_WIGGLE_PARTICLES||!!Math.max(t.wiggle.value,t.wiggle.spread);this.material.needsUpdate=!0},r._applyAttributesToGeometry=function(){var t,e=this.attributes,r=this.geometry,i=r.attributes;for(var a in e)e.hasOwnProperty(a)&&(t=e[a],i["position"===a?"a_Position":a]||r.addAttribute("position"===a?"a_Position":a,t.bufferAttribute));this.geometry.version++,this.geometry.groups[0].count=this.particleCount},e}(x),O={name:"mesh_particle_shader",uniforms:{tex:null},vertexShader:"\n\t\t#include <common_vert>\n\n\t\tattribute vec3 mcol0;\n\t\tattribute vec3 mcol1;\n\t\tattribute vec3 mcol2;\n\t\tattribute vec3 mcol3;\n\t\tattribute vec4 color;\n\n\t\tattribute vec2 a_Uv;\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 varyColor;\n\n\t\t#include <logdepthbuf_pars_vert>\n\n\t\tvoid main() {\n\t\t\tmat4 matrix = mat4(\n\t\t\t\tvec4(mcol0, 0),\n\t\t\t\tvec4(mcol1, 0),\n\t\t\t\tvec4(mcol2, 0),\n\t\t\t\tvec4(mcol3, 1)\n\t\t\t);\n\n\t\t\tvec4 worldPosition = u_Model * matrix * vec4(a_Position, 1.0);\n\t\t\tgl_Position = u_ProjectionView * worldPosition;\n\n\t\t\tvaryColor = color;\n\t\t\tvUv = a_Uv;\n\n\t\t\t#include <logdepthbuf_vert>\n\t\t}\n\t",fragmentShader:"\n\t\tuniform sampler2D tex;\n\n\t\t#include <common_frag>\n\t\t#include <fog_pars_frag>\n\t\t#include <logdepthbuf_pars_frag>\n\n\t\tvarying vec2 vUv;\n\t\tvarying vec4 varyColor;\n\n\t\tvoid main() {\n\t\t\t#include <logdepthbuf_frag>\n\n\t\t\tgl_FragColor = varyColor * texture2D(tex, vUv);\n\n\t\t\t#include <fog_frag>\n\t\t}\n\t"},C=function(){function t(){this._matrix=new i.Matrix4,this._color=new i.Color3(1,1,1),this._opacity=1,this._originPosition=[0,0,0],this._originVelocity=[0,0,0],this._originAcceleration=[0,0,0,0],this._originOpacityArray=[],this._originSizeArray=[],this._originAngleArray=[],this._originColorArray=[1,1,1,1,1,1,1,1,1,1,1,1],this._originParams=[0,0,0,0],this._originRotation=[0,1,0,0,0],this._originRotationCenter=[0,0,0]}var e=t.prototype;return e.isAlive=function(){return!!this._originParams[0]},e.tick=function(t,e,r){this._originParams[1]+=t,this._originParams[1]>this._originParams[2]&&(this._originParams[0]=0),0!==this._originParams[0]?this._update(e,r):this._originParams[1]=0},e.submit=function(t,e){var r=16*e,i=this._matrix.elements;t[r]=i[0],t[r+1]=i[1],t[r+2]=i[2],t[r+3]=i[4],t[r+4]=i[5],t[r+5]=i[6],t[r+6]=i[8],t[r+7]=i[9],t[r+8]=i[10],t[r+9]=i[12],t[r+10]=i[13],t[r+11]=i[14],t[r+12]=this._color.r,t[r+13]=this._color.g,t[r+14]=this._color.b,t[r+15]=this._opacity},e._update=function(t,e){var r=this._originParams[1],i=r/this._originParams[2],n=T.fromArray(this._originAcceleration);if(e.SHOULD_DRAG_PARTICLES){var o=1-.5*i*this._originAcceleration[3];n.multiplyScalar(o)}L.fromArray(this._originVelocity).multiplyScalar(r);var s=n.multiplyScalar(r*r*.5);if(L.add(R.fromArray(this._originPosition)).add(s),e.SHOULD_WIGGLE_PARTICLES){var u=i*this._originParams[3]*Math.PI,l=Math.sin(u),c=Math.cos(u);L.x+=l,L.y+=c,L.z+=l}if(e.SHOULD_ROTATE_PARTICLES){var p=this._originRotation[3];if(0!==p){var f=0;f=0===this._originRotation[4]?p:h.lerp(0,p,i);var d=T.fromArray(this._originRotation),g=P.makeRotationAxis(d,f),m=T.fromArray(this._originRotationCenter).sub(L);m.applyMatrix4(g),L.fromArray(this._originRotationCenter).sub(m)}}if(I.set(1,1,1),e.SHOULD_SIZE_PARTICLES){var y=w(i,this._originSizeArray);I.set(y,y,y)}if(e.isLookAtCamera||e.isLookAtCameraOnlyY)e.isLookAtCamera?M.copy(t.quaternion):e.isLookAtCameraOnlyY&&(P.getInverse(e.group.mesh.worldMatrix),P.multiply(t.worldMatrix),T.setFromMatrixPosition(P),R.copy(L).sub(T),R.y=0,M.setFromUnitVectors(T.set(0,0,-1),R.normalize()));else if(e.SHOULD_ANGLE_PARTICLES){var _=w(i,this._originAngleArray);S.set(_,_,_),M.setFromEuler(S,!1)}this._matrix.transform(L,I,M),e.SHOULD_COLORIZE_PARTICLES?(!function(t,e,r){var i=a.valueOverLifetimeLength-1;if(t<=0)r.fromArray(e,0);else if(t>=1)r.fromArray(e,3*i);else for(var n,o,s,u=t*i,l=0;l<i;l++)if(u>l&&u<l+1){n=u-l,s=(o=3*l)+3,r.r=n*(e[s+0]-e[o+0])+e[o+0],r.g=n*(e[s+1]-e[o+1])+e[o+1],r.b=n*(e[s+2]-e[o+2])+e[o+2];break}}(i,this._originColorArray,this._color),this._opacity=w(i,this._originOpacityArray)):(this._color.setRGB(1,1,1),this._opacity=1)},t}(),T=new i.Vector3,R=new i.Vector3,S=new i.Euler,P=new i.Matrix4,L=new i.Vector3,M=new i.Quaternion,I=new i.Vector3;function w(t,e){var r=a.valueOverLifetimeLength-1,i=0;if(t<=0)i=0;else if(t>=1)i=e[r];else for(var n=t*r,o=0;o<r;o++)if(n>o&&n<o+1){i+=h.lerp(e[o],e[o+1],n-o);break}return i}var V=function(t){function e(e){var r;return(r=t.call(this,e)||this)._activeParticles=new Array,r._particlePool=new Array,r}o(e,t);var r=e.prototype;return r.tick=function(t,e){if(!this.isStatic)if(!1!==this.alive){var r=null!==this.duration&&this.age>this.duration;if(!r)for(var i=this._activeParticles.length,a=this.particlesPerSecond*this.activeMultiplier*t,n=Math.min(i+a,this.particleCount)-i,o=0;o<n;o++){var s=this._particlePool.length<=0?new C:this._particlePool.shift();this._resetParticle(s),this._activeParticles.push(s)}for(var u=0,l=this._activeParticles.length;u<l;u++)if(this._activeParticles[u].tick(t,e,this),this._activeParticles[u].isAlive()){var c=this.group;this._activeParticles[u].submit(c.$instanceBuffer.array,c.$allocBufferIndex())}else this._particlePool.push(this._activeParticles[u]),this._activeParticles.splice(u,1),l--,u--;r&&this._activeParticles.length<=0&&(this.alive=!1,this.age=0),this.alive&&(this.age+=t)}else this.age=0},r.reset=function(t){this.alive=!1,this.age=0,t&&(this._activeParticles=[],this._particlePool=[])},r.$updateFlags=function(t){this.SHOULD_DRAG_PARTICLES=!!Math.max(this.drag._value,this.drag._spread),this.SHOULD_WIGGLE_PARTICLES=!!Math.max(this.wiggle._value,this.wiggle._spread),this.SHOULD_ROTATE_PARTICLES=!!Math.max(this.rotation._angle,this.rotation._angleSpread),this.SHOULD_COLORIZE_PARTICLES=t.colorize,this.SHOULD_SIZE_PARTICLES=!0,this.SHOULD_ANGLE_PARTICLES=!0},r._assignValue=function(t,e,r,i){switch(t){case"position":this._assignPositionValue(e,0);break;case"velocity":case"acceleration":this._assignForceValue(e,0,t,r);break;case"size":case"opacity":this._assignAbsLifetimeValue(e,0,t);break;case"angle":this._assignAngleValue(e,0);break;case"params":this._assignParamsValue(e,0);break;case"rotation":this._assignRotationValue(e,0,i,0);break;case"color":this._assignColorValue(e,0)}},r._resetParticle=function(t){this._assignValue("position",t._originPosition),this._assignValue("velocity",t._originVelocity,t._originPosition),this._assignValue("acceleration",t._originAcceleration,t._originPosition),this._assignValue("opacity",t._originOpacityArray),this._assignValue("size",t._originSizeArray),this._assignValue("angle",t._originAngleArray),this._assignValue("color",t._originColorArray),this._assignValue("params",t._originParams),this._assignValue("rotation",t._originRotation,void 0,t._originRotationCenter)},e}(y),U=function(t){function e(e){var r,a=h.types;e=h.ensureTypedArg(e,a.OBJECT,{}),r=t.call(this,e)||this,void 0===e.maxParticleCount&&(console.warn("MeshParticleGroup: options.maxParticleCount is not provided, set to 1000 by default."),e.maxParticleCount=1e3),r.maxParticleCount=e.maxParticleCount,e.geometry&&e.geometry instanceof i.Geometry||(console.warn("MeshParticleGroup: options.geometry is not provided, set a box geometry by default."),e.geometry=new i.BoxGeometry(1,1,1));var n=function(t,e){var r=t.clone(),a=new i.Buffer(new Float32Array(16*e),16);a.usage=i.BUFFER_USAGE.DYNAMIC_DRAW;var n=new i.Attribute(a,3,0),o=new i.Attribute(a,3,3),s=new i.Attribute(a,3,6),u=new i.Attribute(a,3,9),l=new i.Attribute(a,4,12);return n.divisor=1,o.divisor=1,s.divisor=1,u.divisor=1,l.divisor=1,r.addAttribute("mcol0",n),r.addAttribute("mcol1",o),r.addAttribute("mcol2",s),r.addAttribute("mcol3",u),r.addAttribute("color",l),r}(e.geometry,r.maxParticleCount),o=new i.ShaderMaterial(O);return r._setMaterial(o,e),r.mesh=new i.Mesh(n,o),r.mesh.frustumCulled=!1,r.$instanceBuffer=n.attributes.mcol0.buffer,r._geometry=n,r._particleCount=0,r._aliveParticleCount=0,r}o(e,t);var r,a,s,u=e.prototype;return u.addEmitter=function(t){if(t instanceof V!=!1)if(this._emitters.indexOf(t)>-1)console.error("MeshParticleEmitter already exists in this group. Will not add again.");else{if(null===t.group)return this._particleCount+=t.particleCount,this._particleCount>this.maxParticleCount&&console.warn("MeshParticleGroup: maxParticleCount exceeded. Requesting",this._particleCount,"particles, can support only",this.maxParticleCount),t.group=this,this._emitters.push(t),this.$updateDefines(t),this;console.error("MeshParticleEmitter already belongs to another group. Will not add to requested group.")}else console.error("`emitter` argument must be instance of MeshParticleEmitter. Was provided with:",t)},u.removeEmitter=function(t){var e=this._emitters.indexOf(t);if(t instanceof V!=!1){if(-1!==e)return this._particleCount-=t.particleCount,t.group=null,this._emitters.splice(e,1),this;console.error("MeshParticleEmitter does not exist in this group. Will not remove.")}else console.error("`emitter` argument must be instance of MeshParticleEmitter. Was provided with:",t)},u.tick=function(t,e){var r=this._emitters,i=r.length,a=t||this.fixedTimeStep;if(0!==i){this._aliveParticleCount=0;for(var n=0;n<i;n++)r[n].tick(a,e);this.$instanceBuffer.version++,this._geometry.instanceCount=this._aliveParticleCount}},u.dispose=function(){this.mesh.geometry.dispose(),this.mesh.material.dispose();for(var t=0,e=this._emitters.length;t<e;t++)this._emitters[t].group=null;return this._emitters=[],this._particleCount=0,this._aliveParticleCount=0,this},u.$updateDefines=function(t){t.$updateFlags(this)},u.$allocBufferIndex=function(){return this._aliveParticleCount++},r=e,(a=[{key:"particleCount",get:function(){return this._particleCount}},{key:"aliveParticleCount",get:function(){return this._aliveParticleCount}}])&&n(r.prototype,a),s&&n(r,s),Object.defineProperty(r,"prototype",{writable:!1}),e}(x);t.MeshParticleEmitter=V,t.MeshParticleGroup=U,t.ParticleEmitter=A,t.ParticleGroup=b,t.ParticleProperties=a,Object.defineProperty(t,"__esModule",{value:!0})}));
